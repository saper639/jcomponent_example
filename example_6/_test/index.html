<!DOCTYPE html>
<html>
<head>
	<title>Пример 6</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
	<link rel="stylesheet" href="style.css" />
	<script src="jquery-2.2.4.min.js"></script>
	<script src="masonry.min.js"></script>
	<script src="imagesloaded.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
</head>	
<body>
<template id='tEnd'>	 
	<div class="col-md-12 text-center"><hr><p class="end">End of content</p></div>
</template>
<template id='tCard'>	 
   {{ foreach article in articles }}
      <div class='col-md-4 mb10 item'>
	<div class='thumbnail card'>
	   <a href='{{article.url}}'>	
             <div class='frame'>
              {{ if article.urlToImage }}
	            <img src="{{article.urlToImage}}" class='img-responsive'>
              {{ else }}
	            <img src="no_image.png" class='img-responsive'>
              {{fi}}	  
               <div class='title'>  
                 <div class='head'>
                    {{article.source.name}}                                     
                 </div>  
               </div>
             </div>   
           </a>  
           <div class='caption'>
	      <h3>{{article.title}}<br><small>{{article.publishedAt|format('dd.MM.yyyy hh:mm')}}</small></h3>
              <p>{{article.description}}</p>  
           </div>
        </div>
      </div>	
   {{ end }}
</template>
<div class='container block-content'>
 <hr>
 <div class='text-center'>
    <button type='button' data-bind="null__click:reload" class='btn btn-default'><i class="fa fa-refresh" aria-hidden="true"></i> Reload</button>
 </div>
 <hr>
 <div class='row'>
   <div data-jc="lazyload__null__selector:.lazyload;exec:lazyload;offset:50;">
	<div class="lazyload"><div class='text-center'><img src="https://componentator.com/img/preloader.gif"></div></div>
   </div>
 </div>
</div>
<script src="jctajr.min.js"></script>
<script src="ui.js"></script>
<script>
	var apiKey = '0e1cee0bb93c47768333236ffebcd645';
 	var tCard = Tangular.compile($('#tCard').html()); 	
 	var tEnd = Tangular.compile($('#tEnd').html()); 	
 	var page = 1;
 	function lazyload(el) {
 		console.log('lazy');
   		AJAX('GET https://newsapi.org/v2/everything', { q: 'google', language: 'ru', apiKey:apiKey, page: page, sortBy: 'publishedAt' }, (res, err) => {   	
		    if (res.status=='error') {
		    	$(el).html(tEnd());
		    	return;	
		    };
			$(el).html(tCard(res));
	        page += 1;
	        var $container = $(el);
			// Masonry + ImagesLoaded
			$container.imagesLoaded(function(){
				$container.masonry({
					itemSelector: '.item',		
				});
				el.after('<div class="lazyload"><div class="text-center"><img src="https://componentator.com/img/preloader.gif"></div></div>');
			});		
	   	});
 	}
        function reload() {
          console.log('reload');
          page = 1;
          var lazy = $('.block-content .row');	
	  $(lazy).html('<div data-jc="lazyload__null__selector:.lazyload;exec:lazyload;offset:50;"><div class="lazyload"><div class="text-center"><img src="https://componentator.com/img/preloader.gif"></div></div></div>');
	  COMPILE();	      
        } 
</script>
</body>
</html>